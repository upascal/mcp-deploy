# Contributing to mcp-deploy

Thank you for your interest in contributing to mcp-deploy! This document provides guidelines and instructions for contributing to the project.

## Table of Contents

- [Code of Conduct](#code-of-conduct)
- [Getting Started](#getting-started)
- [Development Setup](#development-setup)
- [Project Structure](#project-structure)
- [Running Tests](#running-tests)
- [Coding Standards](#coding-standards)
- [Submitting Changes](#submitting-changes)
- [Reporting Bugs](#reporting-bugs)
- [Feature Requests](#feature-requests)

## Code of Conduct

This project follows a standard code of conduct. Be respectful, professional, and constructive in all interactions.

## Getting Started

1. Fork the repository on GitHub
2. Clone your fork locally:
   ```bash
   git clone https://github.com/YOUR_USERNAME/mcp-deploy.git
   cd mcp-deploy
   ```
3. Add the upstream repository:
   ```bash
   git remote add upstream https://github.com/upascal/mcp-deploy.git
   ```

## Development Setup

### Prerequisites

- Node.js 20 or higher
- A Cloudflare account (free tier works)
- Git

### Installation

```bash
# Install dependencies
npm install

# Log in to Cloudflare (required for testing deployments)
npx wrangler login

# Start the development server
npm run dev
```

The web interface will be available at http://localhost:3000.

### Environment Variables

On first run, mcp-deploy will auto-generate an encryption key and store it in `.env.local`:

```
ENCRYPTION_KEY=<auto-generated-key>
```

**Never commit `.env.local` to version control.**

## Project Structure

```
mcp-deploy/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── api/                # API routes
│   │   │   ├── cloudflare/     # Cloudflare setup endpoints
│   │   │   ├── mcps/           # MCP management endpoints
│   │   │   └── oauth/          # OAuth flow endpoints
│   │   ├── mcps/               # MCP detail pages
│   │   ├── layout.tsx          # Root layout
│   │   └── page.tsx            # Home page
│   ├── components/             # React components
│   ├── lib/                    # Core library code
│   │   ├── __tests__/          # Unit tests
│   │   ├── db.ts               # SQLite database setup
│   │   ├── store.ts            # Data access layer
│   │   ├── encryption.ts       # AES-256-GCM encryption
│   │   ├── wrangler.ts         # Wrangler CLI integration
│   │   ├── mcp-registry.ts     # MCP registry
│   │   ├── github-releases.ts  # GitHub release fetching
│   │   ├── worker-bearer-wrapper.ts   # Bearer auth wrapper generator
│   │   ├── worker-oauth-wrapper.ts    # OAuth wrapper generator
│   │   └── oauth/              # OAuth provider implementation
│   └── cli/                    # CLI entry point
├── bin/                        # CLI executable
├── data/                       # SQLite database (gitignored)
├── docs/                       # Documentation
└── scripts/                    # Build scripts
```

### Key Technologies

- **Frontend**: Next.js 16 App Router, React 19, Tailwind CSS
- **Backend**: Next.js API routes
- **Storage**: SQLite (`better-sqlite3`) with AES-256-GCM encryption
- **Deployment**: Cloudflare Workers via `wrangler` CLI
- **Testing**: Vitest

## Running Tests

We use Vitest for testing. The test suite includes unit tests for all core functionality.

```bash
# Run all tests
npx vitest run

# Run tests in watch mode
npm test

# Run tests with UI
npm run test:ui

# Run tests with coverage
npm run test:coverage
```

### Writing Tests

- Place test files in `src/lib/__tests__/` or `src/app/api/__tests__/`
- Name test files as `*.test.ts`
- Mock the database using a temporary SQLite file:
  ```typescript
  import { vi } from 'vitest';
  import Database from 'better-sqlite3';

  vi.mock('../db', () => ({
    getDb: () => testDb,
  }));

  const testDb = new Database(':memory:');
  ```
- Add `beforeEach(() => vi.clearAllMocks())` in every `describe` block to avoid stale mock leaks

## Coding Standards

### TypeScript

- All new code must be written in TypeScript
- Use strict type checking (no `any` unless absolutely necessary)
- Prefer explicit return types for functions
- Use interfaces for object shapes

### ESLint

```bash
# Run linter
npm run lint

# Auto-fix issues where possible
npm run lint -- --fix
```

### Code Style

- Use 2 spaces for indentation
- Use single quotes for strings
- Add trailing commas in multi-line objects/arrays
- Write descriptive variable and function names
- Add comments for complex logic

### Commit Messages

Use clear, descriptive commit messages:

```
feat: add support for custom worker names
fix: handle missing GitHub release assets
docs: update README with new CLI commands
test: add tests for OAuth provider
chore: update dependencies
```

## Submitting Changes

### Pull Request Process

1. **Create a feature branch**:
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **Make your changes**:
   - Write code following the coding standards
   - Add tests for new functionality
   - Update documentation as needed

3. **Run tests**:
   ```bash
   npx vitest run
   npm run lint
   ```

4. **Commit your changes**:
   ```bash
   git add .
   git commit -m "feat: description of your changes"
   ```

5. **Push to your fork**:
   ```bash
   git push origin feature/your-feature-name
   ```

6. **Create a Pull Request**:
   - Go to the original repository on GitHub
   - Click "New Pull Request"
   - Select your fork and branch
   - Fill out the PR template with:
     - Description of changes
     - Related issue numbers (if any)
     - Testing performed
     - Screenshots (for UI changes)

7. **Code Review**:
   - Address any feedback from maintainers
   - Push additional commits to your branch as needed
   - Once approved, a maintainer will merge your PR

### Pull Request Guidelines

- Keep PRs focused on a single feature or fix
- Include tests for new functionality
- Update documentation for user-facing changes
- Ensure all tests pass before submitting
- Link to related issues using "Fixes #123" or "Closes #123"

## Reporting Bugs

If you find a bug, please open an issue on GitHub with:

1. **Clear title**: Summarize the bug in one line
2. **Description**: What happened vs. what you expected
3. **Steps to reproduce**:
   ```
   1. Start dev server
   2. Navigate to /mcps/paper-search
   3. Click Deploy
   4. See error
   ```
4. **Environment**:
   - OS: macOS 14.5
   - Node version: 20.11.0
   - mcp-deploy version: 0.1.0
5. **Logs/Screenshots**: Include relevant error messages or screenshots
6. **Possible fix**: If you have ideas on how to fix it (optional)

**Security Issues**: Please report security vulnerabilities privately to upascal@gmail.com. See [SECURITY.md](SECURITY.md) for details.

## Feature Requests

We welcome feature requests! Open an issue with:

1. **Clear title**: Summarize the feature
2. **Problem statement**: What problem does this solve?
3. **Proposed solution**: How should it work?
4. **Alternatives considered**: Other approaches you've thought about
5. **Additional context**: Screenshots, examples, related features

## Adding New MCPs to the Registry

To add support for a new MCP server:

1. **Update the registry** in `src/lib/mcp-registry.ts`:
   ```typescript
   {
     slug: "my-mcp",
     name: "My MCP Server",
     description: "What this MCP does",
     githubRepo: "owner/repo-name",
     workerName: "my-mcp",
     durableObjectClassName: "MyMCP",
     secrets: [
       {
         key: "API_KEY",
         label: "API Key",
         type: "password",
         required: true,
         helpText: "Description of the API key",
         helpUrl: "https://example.com/docs"
       }
     ],
     config: []
   }
   ```

2. **Ensure the MCP repo has**:
   - GitHub releases with `mcp-deploy.json` and `worker.mjs` assets
   - Valid `mcp-deploy.json` metadata
   - See [docs/MCP_RELEASE_GUIDE.md](docs/MCP_RELEASE_GUIDE.md) for details

3. **Add tests** for the new MCP's specific functionality (if needed)

4. **Update documentation** in README.md

## Development Tips

### Database Management

The SQLite database is located at `data/mcp-deploy.db`. To inspect it:

```bash
sqlite3 data/mcp-deploy.db
.tables
.schema mcps
SELECT * FROM mcps;
```

### Debugging Deployments

Enable verbose wrangler output:

```bash
# Add --verbose flag in src/lib/wrangler.ts
wrangler deploy --verbose
```

### Hot Reloading

The Next.js dev server uses Turbopack for fast hot reloading. Changes to files will automatically refresh the browser.

### CLI Development

After making changes to CLI code:

```bash
npm run build
node bin/mcp-deploy.js --help
```

## Questions?

If you have questions about contributing, feel free to:

- Open a GitHub Discussion
- Ask in an issue
- Check existing documentation in the `docs/` folder

Thank you for contributing to mcp-deploy!
